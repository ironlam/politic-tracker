generator client {
  provider = "prisma-client-js"
  output   = "../src/generated/prisma"
}

datasource db {
  provider = "postgresql"
}

// ============================================
// POLITICAL ENTITIES
// ============================================

model Politician {
  id            String    @id @default(cuid())
  slug          String    @unique
  civility      String?   // M. ou Mme
  firstName     String
  lastName      String
  fullName      String    // Computed: "firstName lastName" for search
  birthDate     DateTime?
  deathDate     DateTime? // Date of death (if deceased)
  birthPlace    String?
  photoUrl      String?   // URL de la photo
  photoSource   String?   // Source: "assemblee-nationale", "senat", "gouvernement", "hatvp", "manual"
  officialId    String?   @unique // DEPRECATED: use externalIds instead

  // Current party (nullable if independent)
  currentParty   Party?   @relation(fields: [currentPartyId], references: [id])
  currentPartyId String?

  // Relations
  mandates      Mandate[]
  affairs       Affair[]
  declarations  Declaration[]
  partyHistory  PartyMembership[]
  externalIds   ExternalId[]      // IDs from all external sources
  votes         Vote[]            // Parliamentary votes
  pressMentions PressArticleMention[] // Mentions in press articles

  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  @@index([lastName])
  @@index([currentPartyId])
  @@index([fullName])
}

// External IDs from various data sources - enables multi-source matching
// Supports both politicians and parties (polymorphic)
model ExternalId {
  id            String      @id @default(cuid())

  // Polymorphic: either politician or party (one must be set)
  politician    Politician? @relation(fields: [politicianId], references: [id], onDelete: Cascade)
  politicianId  String?
  party         Party?      @relation(fields: [partyId], references: [id], onDelete: Cascade)
  partyId       String?

  source        DataSource
  externalId    String      // ID in the external system
  url           String?     // Direct URL to the source page

  createdAt     DateTime    @default(now())
  updatedAt     DateTime    @updatedAt

  @@unique([source, externalId])  // One entry per source+ID combo
  @@index([politicianId])
  @@index([partyId])
  @@index([source])
}

enum DataSource {
  ASSEMBLEE_NATIONALE
  SENAT
  PARLEMENT_EUROPEEN
  WIKIDATA
  HATVP
  GOUVERNEMENT
  NOSDEPUTES
  WIKIPEDIA
  MANUAL
}

model Party {
  id          String   @id @default(cuid())
  slug        String?  @unique // URL-friendly identifier
  name        String   @unique
  shortName   String   @unique // Ex: "RN", "LFI", "PS"
  description String?  // Brief description for the party page
  color       String?  // Hex color for UI
  logoUrl     String?

  // Enriched data (from Wikidata or other sources)
  foundedDate       DateTime?
  dissolvedDate     DateTime?
  politicalPosition PoliticalPosition?
  ideology          String?   // Free text, e.g. "Social-démocratie, Socialisme démocratique"
  headquarters      String?
  website           String?

  // Party evolution (succession chain)
  predecessor       Party?   @relation("PartySuccession", fields: [predecessorId], references: [id])
  predecessorId     String?
  successors        Party[]  @relation("PartySuccession") // Parties that succeeded this one

  // Relations
  politicians       Politician[]
  partyMemberships  PartyMembership[]
  affairsAtTime     Affair[]          // Affairs where this was the party at time of conviction
  externalIds       ExternalId[]      // IDs from all external sources (Wikidata, etc.)
  pressMentions     PressArticlePartyMention[]  // Mentions in press articles

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

enum PoliticalPosition {
  FAR_LEFT
  LEFT
  CENTER_LEFT
  CENTER
  CENTER_RIGHT
  RIGHT
  FAR_RIGHT
}

// Track party changes over time
model PartyMembership {
  id           String    @id @default(cuid())
  politician   Politician @relation(fields: [politicianId], references: [id], onDelete: Cascade)
  politicianId String
  party        Party      @relation(fields: [partyId], references: [id])
  partyId      String
  startDate    DateTime
  endDate      DateTime?

  createdAt    DateTime   @default(now())

  @@index([politicianId])
  @@index([partyId])
}

// ============================================
// MANDATES & FUNCTIONS
// ============================================

model Mandate {
  id           String      @id @default(cuid())
  politician   Politician  @relation(fields: [politicianId], references: [id], onDelete: Cascade)
  politicianId String

  type         MandateType
  title        String      // Ex: "Député de la 3ème circonscription du Rhône"
  institution  String      // Ex: "Assemblée nationale"
  role         String?     // Ex: "Président de l'Assemblée nationale", "Vice-président du Sénat"
  constituency String?     // Ex: "Rhône (3ème)"
  departmentCode String?   // Code département (01-95, 2A, 2B, 971-976, 977, 978, 987, 988)

  startDate    DateTime
  endDate      DateTime?
  isCurrent    Boolean     @default(true)

  // Salary info (monthly, in euros)
  baseSalary       Decimal?  @db.Decimal(10, 2)
  totalAllowances  Decimal?  @db.Decimal(10, 2)

  // European Parliament specific (for MEPs)
  europeanGroupCode  String?        // Legacy: group code as text, will be migrated
  europeanGroup      EuropeanGroup? @relation(fields: [europeanGroupId], references: [id])
  europeanGroupId    String?

  // External reference
  externalId   String?     // ID from source API
  sourceUrl    String?     // Link to official page

  createdAt    DateTime    @default(now())
  updatedAt    DateTime    @updatedAt

  @@index([politicianId])
  @@index([type])
  @@index([isCurrent])
  @@index([europeanGroupId])
  @@index([departmentCode])
}

// European Parliament political groups
model EuropeanGroup {
  id          String   @id @default(cuid())
  code        String   @unique  // "PPE", "S&D", "Renew", etc.
  name        String   @unique  // Full name
  shortName   String?           // Display short name if different from code
  color       String?           // Hex color for UI

  // Political positioning
  politicalPosition PoliticalPosition?

  // External references
  wikidataId  String?  @unique  // Wikidata Q-ID
  website     String?

  // Legislature info (groups can change between terms)
  legislature Int?              // EP term number (e.g., 10 for 2024-2029)

  // Relations
  mandates    Mandate[]

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

enum MandateType {
  DEPUTE
  SENATEUR
  DEPUTE_EUROPEEN
  PRESIDENT_REPUBLIQUE
  PREMIER_MINISTRE
  MINISTRE
  SECRETAIRE_ETAT
  MINISTRE_DELEGUE
  PRESIDENT_REGION
  PRESIDENT_DEPARTEMENT
  MAIRE
  ADJOINT_MAIRE
  CONSEILLER_REGIONAL
  CONSEILLER_DEPARTEMENTAL
  CONSEILLER_MUNICIPAL
  OTHER
}

// ============================================
// JUDICIAL AFFAIRS
// ============================================

model Affair {
  id           String         @id @default(cuid())
  politician   Politician     @relation(fields: [politicianId], references: [id], onDelete: Cascade)
  politicianId String

  // Party at time of conviction/affair (for historical accuracy)
  partyAtTime   Party?        @relation(fields: [partyAtTimeId], references: [id])
  partyAtTimeId String?

  title        String         // Ex: "Affaire des emplois fictifs du MoDem"
  slug         String         @unique
  description  String         @db.Text

  status       AffairStatus
  category     AffairCategory

  // Dates
  factsDate    DateTime?      // Date of alleged facts
  startDate    DateTime?      // When affair became public
  verdictDate  DateTime?      // Date of verdict (if any)

  // Outcome (legacy field kept for compatibility)
  sentence     String?        // Ex: "2 ans de prison avec sursis, 5 ans d'inéligibilité"
  appeal       Boolean        @default(false)

  // Detailed sentence breakdown
  prisonMonths        Int?           // Prison sentence in months (0 if none)
  prisonSuspended     Boolean?       // True if suspended sentence (sursis)
  fineAmount          Decimal?       @db.Decimal(12, 2) // Fine in euros
  ineligibilityMonths Int?           // Ineligibility period in months
  communityService    Int?           // Community service hours (TIG)
  otherSentence       String?        // Other penalties (e.g., "interdiction d'exercer")

  // Jurisdiction info
  court              String?         // Ex: "Tribunal correctionnel de Paris"
  chamber            String?         // Ex: "11ème chambre correctionnelle"
  caseNumber         String?         // Ex: "2023/12345"

  // Sources (minimum 1 required - enforced at app level)
  sources      Source[]

  // Timeline events
  events       AffairEvent[]

  // Verification
  verifiedAt   DateTime?
  verifiedBy   String?        // Admin who verified

  createdAt    DateTime       @default(now())
  updatedAt    DateTime       @updatedAt

  @@index([politicianId])
  @@index([status])
  @@index([category])
}

// Timeline events for an affair
model AffairEvent {
  id          String    @id @default(cuid())
  affair      Affair    @relation(fields: [affairId], references: [id], onDelete: Cascade)
  affairId    String

  date        DateTime
  type        AffairEventType
  title       String           // Short description
  description String?   @db.Text // Detailed description

  // Optional source for this specific event
  sourceUrl   String?
  sourceTitle String?

  createdAt   DateTime  @default(now())

  @@index([affairId])
  @@index([date])
}

enum AffairEventType {
  FAITS                    // Les faits se produisent
  REVELATION               // Révélation médiatique
  PLAINTE                  // Dépôt de plainte
  ENQUETE_PRELIMINAIRE     // Ouverture enquête préliminaire
  INFORMATION_JUDICIAIRE   // Ouverture information judiciaire
  PERQUISITION             // Perquisitions
  GARDE_A_VUE              // Garde à vue
  MISE_EN_EXAMEN           // Mise en examen
  CONTROLE_JUDICIAIRE      // Placement sous contrôle judiciaire
  DETENTION_PROVISOIRE     // Placement en détention provisoire
  RENVOI_TRIBUNAL          // Renvoi devant le tribunal
  PROCES                   // Procès
  REQUISITOIRE             // Réquisitoire du procureur
  JUGEMENT                 // Jugement rendu
  APPEL                    // Appel interjeté
  PROCES_APPEL             // Procès en appel
  ARRET_APPEL              // Arrêt de la cour d'appel
  POURVOI_CASSATION        // Pourvoi en cassation
  ARRET_CASSATION          // Arrêt de la Cour de cassation
  RELAXE                   // Relaxe
  ACQUITTEMENT             // Acquittement
  CONDAMNATION             // Condamnation
  PRESCRIPTION             // Prescription
  NON_LIEU                 // Non-lieu
  AUTRE                    // Autre événement
}

enum AffairStatus {
  ENQUETE_PRELIMINAIRE
  INSTRUCTION
  MISE_EN_EXAMEN
  RENVOI_TRIBUNAL
  PROCES_EN_COURS
  CONDAMNATION_PREMIERE_INSTANCE
  APPEL_EN_COURS
  CONDAMNATION_DEFINITIVE
  RELAXE
  ACQUITTEMENT
  NON_LIEU
  PRESCRIPTION
  CLASSEMENT_SANS_SUITE
}

enum AffairCategory {
  CORRUPTION
  CORRUPTION_PASSIVE
  TRAFIC_INFLUENCE
  PRISE_ILLEGALE_INTERETS
  FAVORITISME
  DETOURNEMENT_FONDS_PUBLICS
  FRAUDE_FISCALE
  BLANCHIMENT
  ABUS_BIENS_SOCIAUX
  ABUS_CONFIANCE
  EMPLOI_FICTIF
  FINANCEMENT_ILLEGAL_CAMPAGNE
  FINANCEMENT_ILLEGAL_PARTI
  HARCELEMENT_MORAL
  HARCELEMENT_SEXUEL
  AGRESSION_SEXUELLE
  VIOLENCE
  MENACE
  DIFFAMATION
  INJURE
  INCITATION_HAINE
  FAUX_ET_USAGE_FAUX
  RECEL
  CONFLIT_INTERETS
  AUTRE
}

// Sources for affairs (mandatory for credibility)
model Source {
  id          String   @id @default(cuid())
  affair      Affair   @relation(fields: [affairId], references: [id], onDelete: Cascade)
  affairId    String

  url         String
  title       String   // Article title
  publisher   String   // Ex: "Mediapart", "Le Monde", "AFP"
  publishedAt DateTime

  // Archive for link rot protection
  archivedUrl String?  // archive.org or archive.is URL
  excerpt     String?  @db.Text // Key quote from article

  createdAt   DateTime @default(now())

  @@index([affairId])
  @@index([publisher])
}

// ============================================
// TRANSPARENCY (HATVP)
// ============================================

model Declaration {
  id           String          @id @default(cuid())
  politician   Politician      @relation(fields: [politicianId], references: [id], onDelete: Cascade)
  politicianId String

  type         DeclarationType
  year         Int

  // Patrimony summary (if available)
  realEstate    Decimal?       @db.Decimal(12, 2)
  securities    Decimal?       @db.Decimal(12, 2)
  bankAccounts  Decimal?       @db.Decimal(12, 2)
  otherAssets   Decimal?       @db.Decimal(12, 2)
  liabilities   Decimal?       @db.Decimal(12, 2)
  totalNet      Decimal?       @db.Decimal(12, 2)

  // Source
  hatvpUrl     String          // Link to HATVP page
  pdfUrl       String?         // Direct PDF link

  createdAt    DateTime        @default(now())
  updatedAt    DateTime        @updatedAt

  @@unique([politicianId, type, year])
  @@index([politicianId])
}

enum DeclarationType {
  PATRIMOINE_DEBUT_MANDAT
  PATRIMOINE_FIN_MANDAT
  PATRIMOINE_MODIFICATION
  INTERETS
}

// ============================================
// ADMIN & AUDIT
// ============================================

model AdminUser {
  id           String   @id @default(cuid())
  email        String   @unique
  name         String
  role         AdminRole @default(EDITOR)

  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
  lastLoginAt  DateTime?
}

enum AdminRole {
  SUPER_ADMIN  // Full access
  ADMIN        // Can manage users
  EDITOR       // Can create/edit content
  MODERATOR    // Can verify/approve content
}

// Audit log for all changes
model AuditLog {
  id          String   @id @default(cuid())
  action      String   // CREATE, UPDATE, DELETE
  entityType  String   // Politician, Affair, etc.
  entityId    String
  changes     Json?    // What changed
  userId      String?  // Admin who made the change
  userEmail   String?
  ipAddress   String?

  createdAt   DateTime @default(now())

  @@index([entityType, entityId])
  @@index([userId])
  @@index([createdAt])
}

// ============================================
// PARLIAMENTARY VOTES
// ============================================

model Scrutin {
  id            String       @id @default(cuid())
  externalId    String       @unique  // ID NosDéputés/NosSénateurs (ex: "VTANR5L17V1234" ou "2024-63")
  slug          String?      @unique  // SEO-friendly URL slug (e.g., "2025-01-15-projet-loi-finances")
  title         String       @db.Text
  description   String?      @db.Text
  votingDate    DateTime
  legislature   Int
  chamber       Chamber      @default(AN)  // AN = Assemblée Nationale, SENAT = Sénat

  // Global results
  votesFor      Int
  votesAgainst  Int
  votesAbstain  Int

  result        VotingResult  // ADOPTED, REJECTED
  sourceUrl     String?

  // Relations
  votes         Vote[]

  createdAt     DateTime     @default(now())
  updatedAt     DateTime     @updatedAt

  @@index([votingDate])
  @@index([legislature])
  @@index([chamber])
}

model Vote {
  id            String       @id @default(cuid())
  scrutinId     String
  scrutin       Scrutin      @relation(fields: [scrutinId], references: [id], onDelete: Cascade)
  politicianId  String
  politician    Politician   @relation(fields: [politicianId], references: [id], onDelete: Cascade)

  position      VotePosition  // POUR, CONTRE, ABSTENTION, ABSENT

  @@unique([scrutinId, politicianId])
  @@index([politicianId])
  @@index([scrutinId])
}

enum VotePosition {
  POUR
  CONTRE
  ABSTENTION
  NON_VOTANT
  ABSENT
}

enum VotingResult {
  ADOPTED
  REJECTED
}

enum Chamber {
  AN      // Assemblée Nationale
  SENAT   // Sénat
}

// ============================================
// LEGISLATIVE DOSSIERS (Assemblée Nationale)
// ============================================

model LegislativeDossier {
  id              String        @id @default(cuid())
  externalId      String        @unique  // DLR5L17N12345
  slug            String?       @unique  // SEO-friendly URL slug (e.g., "2024-12-03-reforme-retraites")
  title           String        @db.Text
  shortTitle      String?                // Titre court pour affichage
  number          String?                // PJL 1234, PPL 5678
  status          DossierStatus
  category        String?                // Budget, Santé, Économie...

  filingDate      DateTime?
  examinationDate DateTime?
  adoptionDate    DateTime?

  summary         String?       @db.Text // Résumé IA (3-5 points)
  summaryDate     DateTime?              // Date du dernier résumé

  sourceUrl       String?

  amendments      Amendment[]

  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt

  @@index([status])
  @@index([category])
  @@index([filingDate])
}

enum DossierStatus {
  EN_COURS        // En discussion
  ADOPTE          // Adopté
  REJETE          // Rejeté
  RETIRE          // Retiré
}

model Amendment {
  id              String          @id @default(cuid())
  externalId      String          @unique
  dossierId       String
  number          Int

  authorType      String?         // Groupe, Gouvernement, Individuel
  authorName      String?

  article         String?         // Article modifié
  content         String?         @db.Text  // Texte de l'amendement
  summary         String?         // Résumé IA (1-2 phrases)

  status          AmendmentStatus

  dossier         LegislativeDossier @relation(fields: [dossierId], references: [id], onDelete: Cascade)

  createdAt       DateTime        @default(now())

  @@index([dossierId])
  @@index([status])
}

enum AmendmentStatus {
  DEPOSE          // Déposé
  ADOPTE          // Adopté
  REJETE          // Rejeté
  RETIRE          // Retiré
  TOMBE           // Tombé (sans objet)
}

// ============================================
// AI CHAT & EMBEDDINGS (RAG)
// ============================================

// Embeddings for semantic search (RAG)
// Uses pgvector for efficient similarity search
model ChatEmbedding {
  id            String          @id @default(cuid())

  // What this embedding represents
  entityType    EmbeddingType
  entityId      String          // ID of the politician, dossier, etc.

  // The text that was embedded
  content       String          @db.Text

  // Embedding vector (stored as JSON array, queried via raw SQL with pgvector)
  // OpenAI text-embedding-3-small produces 1536 dimensions
  embedding     Json            // Float[] stored as JSON

  // Metadata for filtering
  metadata      Json?           // Extra context (party, mandate type, etc.)

  createdAt     DateTime        @default(now())
  updatedAt     DateTime        @updatedAt

  @@unique([entityType, entityId])
  @@index([entityType])
}

enum EmbeddingType {
  POLITICIAN        // Politicians bio, mandates
  DOSSIER           // Legislative dossiers
  SCRUTIN           // Voting records
  AFFAIR            // Judicial affairs
  PARTY             // Political parties
}

// Chat conversation history (optional, for context)
model ChatConversation {
  id            String          @id @default(cuid())
  sessionId     String          // Anonymous session identifier

  messages      ChatMessage[]

  createdAt     DateTime        @default(now())
  updatedAt     DateTime        @updatedAt

  @@index([sessionId])
}

model ChatMessage {
  id              String            @id @default(cuid())
  conversation    ChatConversation  @relation(fields: [conversationId], references: [id], onDelete: Cascade)
  conversationId  String

  role            ChatRole
  content         String            @db.Text

  // Sources cited in assistant responses
  sources         Json?             // Array of { type, id, title, url }

  createdAt       DateTime          @default(now())

  @@index([conversationId])
}

enum ChatRole {
  USER
  ASSISTANT
}

// ============================================
// PRESS ARTICLES (RSS)
// ============================================

model PressArticle {
  id            String    @id @default(cuid())

  // Source
  feedSource    String    // "lemonde", "mediapart", "politico"
  externalId    String    // GUID from RSS feed

  // Content (RSS public data only)
  title         String    @db.Text
  description   String?   @db.Text
  url           String    @unique
  imageUrl      String?

  // Publication
  publishedAt   DateTime

  // Relations
  mentions      PressArticleMention[]
  partyMentions PressArticlePartyMention[]

  createdAt     DateTime  @default(now())

  @@unique([feedSource, externalId])
  @@index([feedSource])
  @@index([publishedAt])
}

model PressArticleMention {
  id            String   @id @default(cuid())

  articleId     String
  article       PressArticle @relation(fields: [articleId], references: [id], onDelete: Cascade)

  politicianId  String
  politician    Politician @relation(fields: [politicianId], references: [id], onDelete: Cascade)

  matchedName   String?   // The name found in the article

  @@unique([articleId, politicianId])
  @@index([politicianId])
  @@index([articleId])
}

model PressArticlePartyMention {
  id          String   @id @default(cuid())

  articleId   String
  article     PressArticle @relation(fields: [articleId], references: [id], onDelete: Cascade)

  partyId     String
  party       Party @relation(fields: [partyId], references: [id], onDelete: Cascade)

  matchedName String?   // The name found in the article ("RN", "Rassemblement national", etc.)

  @@unique([articleId, partyId])
  @@index([partyId])
  @@index([articleId])
}
